name: Deploy Backend

# Controls when the workflow will run
on:
     workflow_call:
        inputs:
            wrangler-environment:
                required: true
                type: string
            database-name:
                required: true
                type: string
        outputs:
            backend-url:
                value: ${{ jobs.deploy.outputs.backend-url }}

jobs:
    deploy:
        outputs:
            backend-url: ${{ steps.set-url.outputs.url }}
        runs-on: ubuntu-22.04
        environment: production
        steps:
            - uses: actions/checkout@v6
            - name: Setup Project
              uses: ./.github/actions/setup-project

            - name: Generate files
              working-directory: apps/backend
              run: pnpm ci:generate

            - name: Run Migrations
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
                  environment: ${{ inputs.wrangler-environment }}
                  preCommands: ./scripts/drizzle_flatten.sh
                  command: d1 migrations apply ${{ inputs.database-name }} --remote
                  workingDirectory: apps/backend

            - name: Deploy Backend
              uses: cloudflare/wrangler-action@v3
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
                  environment: ${{ inputs.wrangler-environment }}
                  workingDirectory: apps/backend
                  secrets: |
                      API_KEY
                      REGISTER_SECRET
                      AUTH_CLIENT_SECRET
              env:
                  API_KEY: ${{ secrets.DT65_API_KEY }}
                  REGISTER_SECRET: ${{ secrets.BACKEND_REGISTER_SECRET }}
                  AUTH_CLIENT_SECRET: ${{ secrets.BACKEND_AUTH_CLIENT_SECRET }}

            - name: Set Backend URL
              id: set-url
              run: |
                  if [ "${{ inputs.wrangler-environment }}" = "staging" ]; then
                      echo "url=https://staging-api.downtown65.site" >> $GITHUB_OUTPUT
                  else
                      echo "url=https://api.downtown65.site" >> $GITHUB_OUTPUT
                  fi

            - name: Display Backend URL
              run: |
                  echo "### ðŸš€ ${{ inputs.wrangler-environment }} deployed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Backend URL: ${{ steps.set-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ”— [Open Backend](${{ steps.set-url.outputs.url }})" >> $GITHUB_STEP_SUMMARY