name: Pull Request

on:
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

  # Concurrency group name ensures concurrent workflow runs wait for any in-progress job to finish
concurrency:
  group: merge-${{ github.ref }}

env:
  DATABASE_NAME: "pr-${{ github.event.pull_request.number }}-dt65-backend"
  WORKER_NAME: "pr-${{ github.event.pull_request.number }}-dt65-events-backend"

jobs:
  ci:
    runs-on: ubuntu-22.04
    environment: development
    steps:
      - uses: actions/checkout@v6
      - name: Install pnpm
        uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v6
        with:
          node-version: 22
          cache: pnpm
      - name: Install dependencies
        run: pnpm install --ignore-scripts --frozen-lockfile
      - name: List D1 Databases
        id: list-db
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          command: d1 list --json
          workingDirectory: apps/backend
      - name: Check if DB exists and create if needed
        id: db-setup
        run: |
          DB_NAME="${{ env.DATABASE_NAME }}"
          EXISTING_DB=$(echo '${{ steps.list-db.outputs.command-output }}' | jq -r --arg name "$DB_NAME" '.[] | select(.name == $name) | .uuid')
          
          if [ -n "$EXISTING_DB" ]; then
            echo "Database already exists with ID: $EXISTING_DB"
            echo "database_id=$EXISTING_DB" >> $GITHUB_OUTPUT
          else
            echo "Creating new database..."
            cd apps/backend
            CREATE_OUTPUT=$(npx wrangler d1 create "$DB_NAME" --json)
            DB_ID=$(echo "$CREATE_OUTPUT" | jq -r '.uuid')
            echo "database_id=$DB_ID" >> $GITHUB_OUTPUT
            echo "Created database with ID: $DB_ID"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
      - name: Display Database ID
        run: |
          echo "Using Database ID: ${{ steps.db-setup.outputs.database_id }}"
      - name: Create wrangler config from template
        id: create-config
        run: |
          DB_ID="${{ steps.db-setup.outputs.database_id }}"
          DB_NAME="${{ env.DATABASE_NAME }}"
          WORKER_NAME="${{ env.WORKER_NAME }}"

          sed -i "s/{{VAR_WORKER_NAME}}/${WORKER_NAME}/g" apps/backend/wrangler.jsonc
          sed -i "s/{{VAR_DATABASE_NAME}}/${DB_NAME}/g" apps/backend/wrangler.jsonc
          sed -i "s/{{VAR_DATABASE_ID}}/${DB_ID}/g" apps/backend/wrangler.jsonc
          sed -i "s/{{VAR_AUTH_CLIENT_ID}}/JaoAht7ggce7f5R8DCBGUyjUJeMQEDtz/g" apps/backend/wrangler.jsonc
          sed -i "s/{{VAR_AUTH_DOMAIN}}/dev-dt65.eu.auth0.com/g" apps/backend/wrangler.jsonc
          sed -i "s|{{VAR_AUTH_AUDIENCE}}|https://graphql-dev.downtown65.com|g" apps/backend/wrangler.jsonc
          
          cat apps/backend/wrangler.jsonc      
      - name: Run Migrations
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          environment: pull-request
          preCommands: ./scripts/drizzle_flatten.sh
          command: d1 migrations apply ${{ env.DATABASE_NAME }} --remote
          workingDirectory: apps/backend
      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
          environment: pull-request
          workingDirectory: apps/backend
          secrets: |
            API_KEY
            REGISTER_SECRET
            AUTH_CLIENT_SECRET
        env:
          API_KEY: ${{ secrets.DT65_API_KEY }}
          REGISTER_SECRET: ${{ secrets.BACKEND_REGISTER_SECRET }}
          AUTH_CLIENT_SECRET: ${{ secrets.BACKEND_AUTH_CLIENT_SECRET }}
      
      - name: Sync users table to new database
        run: |
          curl -X POST "https://${{ env.WORKER_NAME }}.dt65.workers.dev/sync/users" \
            --request POST \
            --header 'x-api-key: ${{ secrets.DT65_API_KEY }}' \
      
      # - name: Set Cloudflare environment backend
      #   working-directory: apps/backend
      #   run: |
      #     echo ${{ secrets.BACKEND_AUTH_CLIENT_SECRET }} | wrangler secret put AUTH_CLIENT_SECRET
      #     echo ${{ secrets.BACKEND_REGISTER_SECRET }} | wrangler secret put REGISTER_SECRET
      #     echo ${{ secrets.DT65_API_KEY }} | wrangler secret put API_KEY
      # - name: Set Cloudflare environment frontend
      #   working-directory: apps/frontend
      #   run: |
      #     echo ${{ secrets.FRONTEND_COOKIE_SESSION_SECRET }} | wrangler secret put COOKIE_SESSION_SECRET
      # - name: Generate types
      #   run: pnpm run ci:generate
      # - name: Lint
      #   run: pnpm run ci:lint
      # - name: Typecheck
      #   run: pnpm run typecheck
      # - name: Test
      #   run: pnpm run test
      # - name: Deploy backend to Cloudflare Workers
      #   env:
      #     CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #     CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
      #   working-directory: apps/backend
      #   run: |
      #    pnpm run deploy -e=$WRANGLER_ENV
      # - name: Deploy frontend to Cloudflare Workers
      #   env:
      #     CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      #     CLOUDFLARE_ACCOUNT_ID: ${{ vars.CLOUDFLARE_ACCOUNT_ID }}
      #   working-directory: apps/frontend
      #   run: |
      #    pnpm run deploy -e=$WRANGLER_ENV